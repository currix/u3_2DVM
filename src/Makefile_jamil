#
#
#
include make.inc
#
############################
ifndef PARALLEL		#0
PARALLEL="n"
endif			#0
############################
############################
############################
ifeq ($(FC),gfortran)	#1
LIBS	= $(LAPACK95) $(LAPACK77) $(BLAS) $(TMGLIB)
#***************************
ifeq ($(PARALLEL),y)	#1.1
COMP=fopenmp_$(FC)
FC += -fopenmp
SUF=.oOMP
else			#1.1
COMP=$(FC)		
SUF=.o			#1.1
endif			#1.1
#***************************
else ifeq ($(FC),ifort)	#1
COMP=$(FC)		
LIBS	= $(LAPACK95)		
SUF=.o
ifeq ($(PARALLEL),n)	#1.2
LIBS+=-lmkl_sequential
endif			#1.2
endif			#1
############################
############################
############################
ifeq ($(PARALLEL),y)	#2
MODE=multi-thread	
else			#2
MODE=single-thread	
endif			#2
############################
############################
############################
ifdef BINPATH		#3
ifneq (${BINPATH: -1},/)	#3.1
BINPATH:=$(BINPATH)/
endif			#3.1	
endif			#3
############################
ifdef FC_path		#4
ifneq ($(FC_path: -1),/)	#4.1
FC_path:=$(FC_path)/
endif			#4.1
endif			#4
############################
OPTFLAGS=$(PREP) $(OPTS) $(ARCHFLAGS)

###########################################################################
#Source Code and objects
###########################################################################

vibron2D_Hmod_U3_U2_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 avalavec_modelH_2dvm_u2.f90 
vibron2D_Hmod_U3_U2_OBJ = $(vibron2D_Hmod_U3_U2_SRC:.f90=$(SUF))

vibron2D_Hmod_U3_SO3_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 avalavec_modelH_2dvm_so3.f90 
vibron2D_Hmod_U3_SO3_OBJ = $(vibron2D_Hmod_U3_SO3_SRC:.f90=$(SUF))

###########################################################################

vibron2D_H2b_U3_U2_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 avalavec_2dvm_u2.f90 
vibron2D_H2b_U3_U2_OBJ = $(vibron2D_H2b_U3_U2_SRC:.f90=$(SUF))

vibron2D_H2b_U3_SO3_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 avalavec_2dvm_so3.f90 
vibron2D_H2b_U3_SO3_OBJ = $(vibron2D_H2b_U3_SO3_SRC:.f90=$(SUF))

###########################################################################

vibron2D_H4b_U3_U2_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 ipr_2dvm_4b_u2.f90 
vibron2D_H4b_U3_U2_OBJ = $(vibron2D_H4b_U3_U2_SRC:.f90=$(SUF))

vibron2D_H4b_U3_SO3_SRC = nrtype.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 loggamma.f90 ipr_2dvm_4b_so3.f90 
vibron2D_H4b_U3_SO3_OBJ = $(vibron2D_H4b_U3_SO3_SRC:.f90=$(SUF))

###########################################################################

CHI2_SRC = nrtype.f90 loggamma.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 fit_2dvm.f90 chi_sqre_prg.f90 
CHI2_OBJ = $(CHI2_SRC:.f90=$(SUF))

Min_minuit_SRC = nrtype.f90 loggamma.f90 defparam_2dvm.f90 u3_2dvm_mod.f90 fit_2dvm.f90 minuit-cern.f FCN_func.f90 minimization.f90 
Min_minuit_OBJ = $(addsuffix $(SUF), $(basename ${Min_minuit_SRC}))

###########################################################################
#Object files
###########################################################################

.SUFFIXES:
.SUFFIXES: .f90 .f $(SUF)

.f90$(SUF):	$(info	)
		$(info Compiling $(MODE) object file:)
		$(FC_path)$(FC) -c $(OPTFLAGS) $(MODLIB)   "$<" -o $@

.f$(SUF):	$(info	)
		$(info Compiling $(MODE) object file:)
		$(FC_path)$(FC) -c $(OPTFLAGS) $(MODLIB)   "$<" -o $@


###########################################################################
#Help target [default]
###########################################################################

help:	
	@echo  -e "Open and modify \e[4mmake.inc\e[24m"
	@echo
	@echo  -e "Type:"
	@echo  -e "\t\x24make \033[0;31m <target> \033[0m"
	@echo
	@echo  -e "All programs:"
	@echo  -e "\t\x24make \033[0;31m all \033[0m"
	@echo
	@echo  -e "Delete object and exe files:"
	@echo  -e "\t\x24make \033[0;31m clean \033[0m"
	@echo
	@echo  -e "Targets:"
	@echo  -e "\t\033[0;32m${ALL_PGR} \033[0m"
	@echo
	@echo  -e "Options: "
	@echo  -e "\t\033[0;34mFC---------> Compiler: gfortran/ifort\n\tPARALLEL---> If 'y', then more than one thread will be available,\n\t\t\totherwise, set to 'n'\n\tBINPATH----> Exe files location. \033[0m"
	@echo

###########################################################################
#All Programs
###########################################################################

ALL_PGR=vibron2D_Hmod_U3_U2 vibron2D_Hmod_U3_SO3 vibron2D_H2b_U3_U2 vibron2D_H2b_U3_SO3 vibron2D_H4b_U3_U2 vibron2D_H4b_U3_SO3 chi2_U3 Min_minuit

all: $(ALL_PGR)

###########################################################################
#Linking programs
###########################################################################

vibron2D_Hmod_U3_U2:	$(vibron2D_Hmod_U3_U2_OBJ) Makefile 
			$(info )
			$(info Linking $(MODE) $@ executable:)
			$(FC_path)$(FC)  -o $(BINPATH)$@_$(COMP) $(vibron2D_Hmod_U3_U2_OBJ) $(OPTFLAGS) $(LIBS)

vibron2D_Hmod_U3_SO3: $(vibron2D_Hmod_U3_SO3_OBJ) Makefile
			$(info )
			$(info Linking $(MODE) $@ executable:)
			$(FC_Path)$(FC) -o $(BINPATH)$@_$(COMP) $(vibron2D_Hmod_U3_SO3_OBJ) $(OPTFLAGS) $(LIBS)

###########################################################################

vibron2D_H2b_U3_U2:	$(vibron2D_H2b_U3_U2_OBJ) Makefile 
			$(info )
			$(info Linking $(MODE) $@ executable:)
			$(FC_path)$(FC)  -o $(BINPATH)$@_$(COMP) $(vibron2D_H2b_U3_U2_OBJ) $(OPTFLAGS) $(LIBS)

vibron2D_H2b_U3_SO3: $(vibron2D_H2b_U3_SO3_OBJ) Makefile
			$(info )
			$(info Linking $(MODE) $@ executable:)
			$(FC_Path)$(FC) -o $(BINPATH)$@_$(COMP) $(vibron2D_H2b_U3_SO3_OBJ) $(OPTFLAGS) $(LIBS)

###########################################################################

vibron2D_H4b_U3_U2:	$(vibron2D_H4b_U3_U2_OBJ) Makefile 
			$(info )
			$(info Linking single thread $@ executable:)
			$(FC_path)$(FC)  -o $(BINPATH)$@_$(COMP) $(vibron2D_H4b_U3_U2_OBJ) $(OPTFLAGS) $(LIBS)

vibron2D_H4b_U3_SO3: $(vibron2D_H4b_U3_SO3_OBJ) Makefile
			$(info )
			$(info Linking $(MODE) $@ executable:)
			$(FC_path)$(FC) -o $(BINPATH)$@_$(COMP) $(vibron2D_H4b_U3_SO3_OBJ) $(OPTFLAGS) $(LIBS)

###########################################################################

chi2_U3: $(CHI2_OBJ) Makefile
		$(info )
		$(info Linking $(MODE) $@ executable:)
		$(FC_path)$(FC) -Wall -o $(BINPATH)$@_$(COMP) $(CHI2_OBJ) $(OPTFLAGS) $(LIBS)

###########################################################################

Min_minuit: $(Min_minuit_OBJ) Makefile
		$(info )
		$(info Linking $(MODE) $@ executable:)
		$(FC_path)$(FC) -o $(BINPATH)$@_$(COMP) $(Min_minuit_OBJ) $(OPTFLAGS) $(LIBS)

###########################################################################

clean:
	@echo "Cleaning object files"
	@rm -f *.o *.mod *.oOMP
	@echo "Cleaning exe files"
	@rm -f $(BINPATH)/vibron2D* $(BINPATH)/chi2_U3* $(BINPATH)/Min_minuit*
